name: madara_runner

services:
  madara:
    image: madara:latest
    container_name: "madara_runner"
    cpus: "4.0"
    mem_limit: "16gb"
    ports:
      - 9944:9944
    labels:
      - "autoheal=true"
    environment:
      - RPC_API_KEY_FILE=/run/secrets/rpc_api_key
    secrets:
      - rpc_api_key
    volumes:
      - /var/lib/madara:/tmp/madara
      - ./madara-runner.sh:/usr/local/bin/runner.sh:ro
    entrypoint:
      - /usr/local/bin/runner.sh
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9944/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: on-failure:3

  explorer:
    image: sotazklabs/stark_compass_explorer:v0.2.38
    container_name: "madara_explorer"
    ports:
      - "4000:4000"
    environment:
      - DB_TYPE=postgresql # set to postgresql if you want to use postgresql, empty otherwise (sqlite).
      - DISABLE_MAINNET_SYNC=true # Set to true if you want to disable mainnet sync
      - DISABLE_SEPOLIA_SYNC=false # Set to true if you want to disable sepolia sync
      - RPC_API_HOST=http://madara:9944 # Set to your sepolia rpc api host, is will be used in the explorer as "Sepolia"
      - SEPOLIA_RPC_API_HOST=http://madara:9944 # Set to your sepolia rpc api host, is will be used in the explorer as "Sepolia"
      - SECRET_KEY_BASE=JyULoT5cLBifW+XNEuCTVoAb+SaFgQt9j227RN0cKpR3wTsrApGd1HNcgeopemyl
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/postgres
      - PHX_HOST=10.20.10.121
      - PORT=4000

  explorer_db:
    image: postgres:14.6
    container_name: "madara_explorer_db"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    volumes:
      - explorer_db:/var/lib/postgresql/data

  autoheal:
    image: willfarrell/autoheal:latest
    tty: true
    restart: always
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock
volumes:
  explorer_db:

secrets:
  rpc_api_key:
    file: .secrets/rpc_api.secret
